import{r as f,c as q,j as s,D as J,a as K,b as Q,C as Z,d as O,e as ee,X as F,f as te,g as se,h as V,L as b,I as p,B as j,P as ae,T as ne,i as oe,S as le}from"./index-BjgGgDfQ.js";const ie=({isOpen:y,onClose:N,onSave:E,initialConfig:T})=>{const[o,m]=f.useState(T),[w,S]=f.useState(null),P=f.useRef(null),M=800,k=400,a=40,h=M-2*a,r=k-2*a,[i,z]=f.useState(60),[c,H]=f.useState(100);f.useEffect(()=>{m(T)},[T,y]),f.useEffect(()=>{y&&W()},[o,y,i,c]);const W=()=>{const e=P.current;if(!e)return;const t=e.getContext("2d");t&&(t.clearRect(0,0,M,k),t.strokeStyle="#e5e7eb",t.fillStyle="#374151",t.font="12px sans-serif",R(t),G(t),o.curvePoints.length>0&&B(t),L(t))},R=e=>{e.strokeStyle="#f3f4f6";for(let t=0;t<=10;t++){const n=a+h*t/10;e.beginPath(),e.moveTo(n,a),e.lineTo(n,a+r),e.stroke()}for(let t=0;t<=10;t++){const n=a+r*t/10;e.beginPath(),e.moveTo(a,n),e.lineTo(a+h,n),e.stroke()}},G=e=>{e.strokeStyle="#9ca3af",e.fillStyle="#374151",e.beginPath(),e.moveTo(a,a+r),e.lineTo(a+h,a+r),e.stroke(),e.beginPath(),e.moveTo(a,a),e.lineTo(a,a+r),e.stroke();for(let t=0;t<=10;t++){const n=a+h*t/10,l=(i*t/10).toFixed(0);e.fillText(l,n-10,a+r+20)}e.fillText("Time (min)",a+h/2-30,k-5);for(let t=0;t<=10;t++){const n=a+r-r*t/10,l=(c*t/10).toFixed(0);e.fillText(l,5,n+4)}e.save(),e.translate(15,a+r/2),e.rotate(-Math.PI/2),e.fillText("MeterValue (kWh)",-40,0),e.restore()},B=e=>{const t=[...o.curvePoints].sort((l,d)=>l.time-d.time);e.strokeStyle="#3b82f6",e.lineWidth=2,e.beginPath();const n=100;for(let l=0;l<=n;l++){const d=l/n,g=q(d,t),v=t[0].time+(t[t.length-1].time-t[0].time)*d,u=a+v/i*h,x=a+r-g/c*r;l===0?e.moveTo(u,x):e.lineTo(u,x)}e.stroke(),e.lineWidth=1},L=e=>{o.curvePoints.forEach((t,n)=>{const l=a+t.time/i*h,d=a+r-t.value/c*r;e.fillStyle=n===w?"#ef4444":"#10b981",e.beginPath(),e.arc(l,d,6,0,2*Math.PI),e.fill(),e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke(),e.lineWidth=1,e.fillStyle="#374151",e.fillText(`(${t.time.toFixed(1)}, ${t.value.toFixed(1)})`,l+10,d-10)})},_=e=>{const t=P.current;if(!t)return;const n=t.getBoundingClientRect(),l=e.clientX-n.left,d=e.clientY-n.top,g=o.curvePoints.findIndex(v=>{const u=a+v.time/i*h,x=a+r-v.value/c*r;return Math.sqrt((l-u)**2+(d-x)**2)<10});if(g>=0)S(g);else{const v=(l-a)/h*i,u=(a+r-d)/r*c;v>=0&&v<=i&&u>=0&&u<=c&&m({...o,curvePoints:[...o.curvePoints,{time:v,value:u}].sort((x,C)=>x.time-C.time)})}},U=e=>{if(w===null)return;const t=P.current;if(!t)return;const n=t.getBoundingClientRect(),l=e.clientX-n.left,d=e.clientY-n.top,g=Math.max(0,Math.min(i,(l-a)/h*i)),v=Math.max(0,Math.min(c,(a+r-d)/r*c)),u=[...o.curvePoints];u[w]={time:g,value:v},m({...o,curvePoints:u.sort((x,C)=>x.time-C.time)})},A=()=>{S(null)},X=e=>{if(o.curvePoints.length<=2){alert("Must have at least 2 control points");return}m({...o,curvePoints:o.curvePoints.filter((t,n)=>n!==e)}),S(null)},Y=()=>{const e=i/2,t=c/2;m({...o,curvePoints:[...o.curvePoints,{time:e,value:t}].sort((n,l)=>n.time-l.time)})},D=(e,t,n)=>{const l=[...o.curvePoints];l[e]={...l[e],[t]:n},m({...o,curvePoints:l.sort((d,g)=>d.time-g.time)})},$=()=>{E(o),N()},I=e=>{let t=[];switch(e){case"linear":t=[{time:0,value:0},{time:i,value:c}];break;case"exponential":t=[{time:0,value:0},{time:i*.3,value:c*.1},{time:i*.6,value:c*.4},{time:i,value:c}];break;case"step":t=[{time:0,value:0},{time:i*.5,value:0},{time:i*.5,value:c},{time:i,value:c}];break}m({...o,curvePoints:t})};return s.jsx(J,{open:y,onOpenChange:e=>!e&&N(),children:s.jsxs(K,{children:[s.jsx(Q,{className:"!z-[10000]"}),s.jsxs(Z,{className:O("fixed left-[50%] top-[50%] !z-[10001] grid w-full max-w-6xl translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%]","data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg max-h-[90vh] overflow-y-auto"),children:[s.jsxs(ee,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(F,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]}),s.jsx(te,{children:s.jsx(se,{children:"Configure Auto MeterValue"})}),s.jsxs("div",{className:"space-y-4 py-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(V,{id:"autoEnabled",checked:o.enabled,onCheckedChange:e=>m({...o,enabled:e})}),s.jsx(b,{htmlFor:"autoEnabled",children:"Enable Auto MeterValue"})]}),s.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-900",children:[s.jsx("canvas",{ref:P,width:M,height:k,onClick:_,onMouseMove:U,onMouseUp:A,onMouseLeave:A,className:"cursor-crosshair bg-white rounded",style:{display:"block",margin:"0 auto"}}),s.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-2 text-center",children:"Click to add control points, drag to move them"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx(b,{htmlFor:"maxTime",children:"Max Time (minutes)"}),s.jsx(p,{id:"maxTime",type:"number",value:i,onChange:e=>z(Number(e.target.value)),min:1})]}),s.jsxs("div",{children:[s.jsx(b,{htmlFor:"maxValue",children:"Max Value (kWh)"}),s.jsx(p,{id:"maxValue",type:"number",value:c,onChange:e=>H(Number(e.target.value)),min:1})]})]}),s.jsxs("div",{children:[s.jsx(b,{children:"Presets"}),s.jsxs("div",{className:"flex gap-2 mt-2",children:[s.jsx(j,{size:"sm",variant:"secondary",onClick:()=>I("linear"),children:"Linear"}),s.jsx(j,{size:"sm",variant:"secondary",onClick:()=>I("exponential"),children:"Exponential"}),s.jsx(j,{size:"sm",variant:"secondary",onClick:()=>I("step"),children:"Step"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx(b,{htmlFor:"intervalSeconds",children:"Send Interval (seconds)"}),s.jsx(p,{id:"intervalSeconds",type:"number",value:o.intervalSeconds,onChange:e=>m({...o,intervalSeconds:Number(e.target.value)}),min:1,disabled:o.autoCalculateInterval})]}),s.jsxs("div",{className:"flex items-center gap-2 mt-6",children:[s.jsx(V,{id:"autoCalculateInterval",checked:o.autoCalculateInterval,onCheckedChange:e=>m({...o,autoCalculateInterval:e})}),s.jsx(b,{htmlFor:"autoCalculateInterval",children:"Auto Calculate"})]})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx(b,{children:"Control Points"}),s.jsxs(j,{size:"sm",variant:"success",onClick:Y,children:[s.jsx(ae,{className:"mr-2 h-4 w-4"}),"Add Point"]})]}),s.jsx("div",{className:"max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded p-2 bg-gray-50 dark:bg-gray-800",children:o.curvePoints.map((e,t)=>s.jsxs("div",{className:"flex items-center gap-2 mb-2 p-2 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600",children:[s.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-2",children:[s.jsxs("div",{children:[s.jsx(p,{type:"number",value:e.time.toFixed(2),onChange:n=>D(t,"time",Number(n.target.value)),className:"text-xs",step:.1}),s.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"min"})]}),s.jsxs("div",{children:[s.jsx(p,{type:"number",value:e.value.toFixed(2),onChange:n=>D(t,"value",Number(n.target.value)),className:"text-xs",step:.1}),s.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"kWh"})]})]}),s.jsx(j,{size:"icon",variant:"ghost",onClick:()=>X(t),disabled:o.curvePoints.length<=2,className:"text-red-600 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900",children:s.jsx(ne,{className:"h-4 w-4"})})]},t))})]})]}),s.jsxs(oe,{children:[s.jsxs(j,{variant:"secondary",onClick:N,children:[s.jsx(F,{className:"mr-2 h-5 w-5"}),"Cancel"]}),s.jsxs(j,{onClick:$,children:[s.jsx(le,{className:"mr-2 h-5 w-5"}),"Save"]})]})]})]})})};export{ie as default};
